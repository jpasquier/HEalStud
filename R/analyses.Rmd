---
title: "Etude HealStud - Analyse des données à T`r params$temps`"
subtitle: "`r if (!is.null(params$dom)) paste('Domaine :', params$dom)`"
author: "Jérôme Pasquier"
date: "`r params$date`"
output:
  html_document:
    toc: true
    toc_depth: 4
    toc_float: false
    code_folding: hide
params:
    temps: NA
    dom: NA
    date: ""
---

<!--
Zoom function in rmarkdown html plot
Source: https://stackoverflow.com/questions/56361986/
-->

```{css zoom-lib-src, echo = FALSE}
script src = "https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"
```

```{js zoom-jquery, echo = FALSE}
 $(document).ready(function() {
    $('body').prepend('<div class=\"zoomDiv\"><img src=\"\" class=\"zoomImg\"></div>');
    // onClick function for all plots (img's)
    $('img:not(.zoomImg)').click(function() {
      $('.zoomImg').attr('src', $(this).attr('src')).css({width: '100%'});
      $('.zoomDiv').css({opacity: '1', width: 'auto', border: '1px solid white', borderRadius: '5px', position: 'fixed', top: '50%', left: '50%', marginRight: '-50%', transform: 'translate(-50%, -50%)', boxShadow: '0px 0px 50px #888888', zIndex: '50', overflow: 'auto', maxHeight: '100%'});
    });
    // onClick function for zoomImg
    $('img.zoomImg').click(function() {
      $('.zoomDiv').css({opacity: '0', width: '0%'}); 
    });
  });
```

<!-- =============================== Setup ================================ -->

```{r setup, message=FALSE}

library(knitr)
library(dplyr)
library(labelled)
library(pander)
library(binom)
library(psych)
library(lavaan)
library(ggplot2)
#library(scales)
library(GGally)
library(semPlot)
library(xfun)
library(XLConnect)
library(writexl)

# --------------------------------- Options --------------------------------- #

options(knitr.kable.NA = "")

# ---------------------------- Working directory ---------------------------- #

# setwd("~/Projects/LaSource/Guzman - Healthy Students/R")

# -------------------------------- Load data -------------------------------- #

temps <- params$temps
load("~/Projects/LaSource/Guzman - Healthy Students/data/hs_20201119.rda")
hs <- hs[hs$Temps == temps, ]
if (!is.na(params$dom)) {
  if (params$dom == "Soins infirmiers") {
    hs <- hs[to_factor(hs$Filiere) == params$dom, ]
  } else {
    hs <- hs[to_factor(hs$Domaine) == params$dom, ]
  }
}
```

<!-- ======================= Descriptive statistics ======================= -->


## Statistiques descriptives

Nombre d'observations : `r nrow(hs)`.

Une description de la distribution de chaque variable de la base de données se
trouve dans les fichiers ci-dessous.

```{r descr_stat}

# ------------------------- Descriptive statistics -------------------------- #

X <- c("WHOQOL_(1|2|d[1-4]_.+)", "PSS14_tot", "PSS10_tot", "GSES_tot",
       "CD_RISC_tot", "MAAS_tot", "^MSPSS_.+", "(S)?HFI_(d[1-6]|tot)",
       "Act_lucrative", "Annee_etude", "Bon", "Domaine", "ENSA", "Etat_civil",
       "Filiere", "Follow_up", "HESSOGeneve", "Recrutement", "Sexe")
if (temps == 0.5) {
  X <- X[!(X %in% c("PSS10_tot", "Bon"))]
  X <- c(X, "HEalStud_1", "COVID19_[1-4]", "PTGI_.+")
}
X <- paste0("^", X, "$")
X <- do.call(base::c, lapply(X, grep, x = names(hs), value = TRUE))
fig_descr <- list()
tbl_descr <- do.call(rbind, lapply(X, function(x) {
  if (any(class(hs[[x]]) == "haven_labelled")) hs[[x]] <- to_factor(hs[[x]])
  type <- paste(class(hs[[x]]), collapse = " ")
  z <- na.omit(hs[[x]])
  if (any(class(hs[[x]]) %in% c("factor", "logical"))) {
    if (any(class(z) == "factor")) z <- droplevels(z)
    tab <- table(z)
    ci <- t(sapply(tab, function(x) {
      y <- binom.confint(x = x, n = sum(tab), method = "wilson")
      unlist(y[, c("lower", "upper")])
    }))
    tab <- cbind(tab, prop.table(tab), ci)
    tab <- data.frame(rownames(tab), tab)
    if (any(nchar(as.character(z)) > 15)) {
      rotate <- TRUE
      levels(hs[[x]]) <- sapply(levels(hs[[x]]), function(w) {
        if (nchar(w) > 15) w <- paste0(substr(w, 1, 12), "...")
        w
      })
    } else {
      rotate <- FALSE
    }
    fig <- ggplot(hs[!is.na(hs[[x]]), ], aes_string(x = x)) +
      geom_bar(aes(y = (..count..)/sum(..count..)), fill = "steelblue") +
      scale_y_continuous(labels=scales::percent) +
      labs(y = "Fréquences relatives") +
      theme_classic()
    if (rotate) {
      fig <- fig +
        theme(axis.text.x = element_text(angle = 45, hjust = 1))
    }
    fig_descr[[x]] <<- fig
  } else if (class(hs[[x]]) %in% c("numeric", "integer")) {
    if (length(z) > 1) {
      hci <- qt(0.975, length(z) - 1) * sd(z) / sqrt(length(z))
    } else {
      hci <- NA
    }
    tab <- data.frame(
      c("Mean/SD", "Median/IQR", "Min/Max"),
      c(mean(z), median(z), min(z)),
      c(sd(z), IQR(z), max(z)),
      c(mean(z) - hci, NA, NA),
      c(mean(z) + hci, NA, NA)
    )
    brx <- pretty(range(z), n = nclass.Sturges(z), min.n = 1)
    fig <- ggplot(hs[!is.na(hs[[x]]), ], aes_string(x = x)) +
      geom_histogram(color = "darkgray", fill = "steelblue", breaks = brx)
    y_range <- ggplot_build(fig)$layout$panel_params[[1]]$y.range
    fig <- fig +
      geom_boxplot(aes(y = y_range[2] * 1.1),
                   width = sum(y_range * c(-1, 1)) / 10) +
      theme_classic()
    fig_descr[[x]] <<- fig
  } else {
    stop(paste0(x, ": unsupported type (", type, ")"))
  }
  tab <- cbind(x, type, sum(is.na(hs[[x]])), tab)
  names(tab) <- 
    c("Variable", "Type", "Nmiss", "Value", "(N)", "(Prop)", "2.5 %", "97.5 %")
  rownames(tab) <- NULL
  return(tab)
}))
rm(X)

```

<!-- =========================== Export tables ============================ -->

```{r descr_stat_export_tables, echo=FALSE}

# ------------------------------ Export tables ------------------------------ #

f <- "/tmp/descr_stat.xlsx"
if (file.exists(f)) file.remove(f)
wb <- loadWorkbook(f, create = TRUE)
## Init WB
r <- tbl_descr
s <- "descr (table 1)"
mc_var <- list(r$Variable)
mc_list <- c("B", "C")
createSheet(wb, name = s)
writeWorksheet(wb, r, sheet = s)
## Merged cells
mc <- aggregate(1:nrow(r), mc_var, function(x) {
  if(length(x) > 1) {
    x <- x + 1
    out <- paste0("A", min(x), ":A", max(x))
  } else {
    out <- NA
  }
  return(out)
})[, length(mc_var) + 1]
mc <- mc[!is.na(mc)]
mc <- c(mc, sapply(mc_list, function(z) gsub("A", z, mc)))
mergeCells(wb, sheet = s, reference = mc)
## Borders
cs <- createCellStyle(wb)
setBorder(cs, side = "top", type = XLC$"BORDER.THIN",
          color = XLC$"COLOR.BLACK")
for(i in aggregate(1:nrow(r), mc_var, min)[, length(mc_var) + 1] + 1) {
  setCellStyle(wb, sheet = s, row = i, col = 1:ncol(r), cellstyle = cs)
}
## Colors
cs <- createCellStyle(wb)
setFillPattern(cs, fill = XLC$"FILL.SOLID_FOREGROUND")
setFillForegroundColor(cs, color = XLC$"COLOR.YELLOW")
## Save WB
saveWorkbook(wb)
## Export file
embed_file(f, text = "Statistiques descriptives (xlsx)")
f <- file.remove(f)
## Remove unused variables
rm(f, wb, r, s, mc_var, mc_list, mc, cs, i)

```

<!-- =========================== Export figures =========================== -->

```{r descr_stat_export_figures, echo=FALSE}

# ----------------------------- Export figures ------------------------------ #

f <- "/tmp/descr_stat.pdf"
cairo_pdf(f, onefile = TRUE)
for (fig in fig_descr) print(fig)
garbage <- dev.off()
embed_file(f, text = "Statistiques descriptives (pdf)")
f <- file.remove(f)
rm(f, fig, garbage)

```

<!-- =========== Correlation betwwen PSS14 and WHOQOL-BREF-PSY ============ -->

## Corrélation entre le score PSS-14 et le score WHOQOL-BREF-PSY

```{r cor_pss14_whoqolpsy_1}

# -------------- Correlation betwwen PSS14 and WHOQOL-BREF-PSY -------------- #

# Select complete cases
subdat <- na.omit(hs[c("WHOQOL_d2_raw_score", "PSS14_tot")])
# Number of complete cases
n <- nrow(subdat)
# Pearson coefficient
p <- cor.test(subdat$WHOQOL_d2_raw_score, subdat$PSS14_tot)
# Spearman coefficient
s <- cor.test(subdat$WHOQOL_d2_raw_score, subdat$PSS14_tot,
              method = "spearman", exact = FALSE)
# Confidence interval of the Spearman coefficient
sci <- tanh(atanh(s$estimate) + c(-1, 1) * qnorm(0.975) / sqrt(n - 3))

```

```{r cor_pss14_whoqolpsy_2, echo=FALSE}

p_char <- paste0(
  signif(p$estimate, 3),
  " (IC [",
  paste(signif(p$conf.int, 3), collapse = ";"),
  "], p",
  ifelse(p$p.value < .001, "<.001", paste0("=", round(p$p.value, 3))),
  ")"
)
s_char <- paste0(
  signif(s$estimate, 3),
  " (IC [",
  paste(signif(sci, 3), collapse = ";"),
  "], p",
  ifelse(s$p.value < .001, "<.001", paste0("=", round(s$p.value, 3))),
  ")"
)

```

Il y a `r n` observations pour lesquelles les deux variables sont disponibles.
Le coeficient de corrélation de Pearson est égal à `r p_char` et celui de
Spearman est égal à `r s_char`.

Un analyse de régression linéaire fait également ressortir l'association entre
les deux variables.

<details><summary>Analyse de régression</summary>
```{r cor_pss14_whoqolpsy_3, out.width="100%"}

# ----------- Linear resgression WHOQOL_d2_raw_score ~ PSS14_tot ------------ #

m <- lm(WHOQOL_d2_raw_score ~ PSS14_tot, subdat)
summary(m)

ggplot(subdat, aes(x = PSS14_tot, y = WHOQOL_d2_raw_score)) +
  geom_point() +
  geom_smooth(formula = y ~ x, method = lm) +
  labs(caption = paste(nrow(subdat), "observations")) +
  theme_classic()

ggplot(m) +
  stat_qq(aes(sample = .stdresid)) +
  geom_abline() +
  labs(x = "Theoretical Quantiles", y = "Standardized Residuals",
       title = "Normal Q-Q Plot") +
  theme_classic()

```
</details>

<!-- BEGIN PSS10 -->
<details><summary>PSS10</summary>

```{r cor_pss10_whoqolpsy_1}

# -------------- Correlation betwwen PSS14 and WHOQOL-BREF-PSY -------------- #

# Select complete cases
subdat <- na.omit(hs[c("WHOQOL_d2_raw_score", "PSS10_tot")])
# Number of complete cases
n <- nrow(subdat)
# Pearson coefficient
p <- cor.test(subdat$WHOQOL_d2_raw_score, subdat$PSS10_tot)
# Spearman coefficient
s <- cor.test(subdat$WHOQOL_d2_raw_score, subdat$PSS10_tot,
              method = "spearman", exact = FALSE)
# Confidence interval of the Spearman coefficient
sci <- tanh(atanh(s$estimate) + c(-1, 1) * qnorm(0.975) / sqrt(n - 3))

```

```{r cor_pss10_whoqolpsy_2, echo=FALSE}

p_char <- paste0(
  signif(p$estimate, 3),
  " (IC [",
  paste(signif(p$conf.int, 3), collapse = ";"),
  "], p",
  ifelse(p$p.value < .001, "<.001", paste0("=", round(p$p.value, 3))),
  ")"
)
s_char <- paste0(
  signif(s$estimate, 3),
  " (IC [",
  paste(signif(sci, 3), collapse = ";"),
  "], p",
  ifelse(s$p.value < .001, "<.001", paste0("=", round(s$p.value, 3))),
  ")"
)

```

Il y a `r n` observations pour lesquelles les deux variables sont disponibles.
Le coeficient de corrélation de Pearson est égal à `r p_char` et celui de
Spearman est égal à `r s_char`.

Un analyse de régression linéaire fait également ressortir l'association entre
les deux variables.

<details><summary>Analyse de régression</summary>
```{r cor_pss10_whoqolpsy_3, out.width="100%"}

# ----------- Linear resgression WHOQOL_d2_raw_score ~ PSS14_tot ------------ #

m <- lm(WHOQOL_d2_raw_score ~ PSS10_tot, subdat)
summary(m)

ggplot(subdat, aes(x = PSS10_tot, y = WHOQOL_d2_raw_score)) +
  geom_point() +
  geom_smooth(formula = y ~ x, method = lm) +
  labs(caption = paste(nrow(subdat), "observations")) +
  theme_classic()

ggplot(m) +
  stat_qq(aes(sample = .stdresid)) +
  geom_abline() +
  labs(x = "Theoretical Quantiles", y = "Standardized Residuals",
       title = "Normal Q-Q Plot") +
  theme_classic()

```
</details>

</details>
<!-- END PSS10 -->

```{r cleaning, echo=FALSE}
rm(m, n, p, p_char, s, s_char, sci, subdat)
```

<!-- ======== Correlations between WHOQOL_PSY/PSS14 and moderators ======== -->

## Corrélations entre le WHOQOL-PSY/PSS14 et les variables modératrices

```{r tab_cor_moderators}
Y <- c("PSS14_tot", "WHOQOL_d2_raw_score")
X <- c("PSS14_tot", "GSES_tot", "CD_RISC_tot", "MAAS_tot", "MSPSS_tot")
if (temps == 0.5) X <- c(X, "PTGI_tot")
tab_cor <- do.call(rbind, lapply(Y, function(y) {
  do.call(rbind, lapply(X, function(x) {
    subdat <- na.omit(hs[c(x, y)])
    n <- nrow(subdat)
    w <- do.call(base::c, lapply(c("pearson", "spearman"), function(method) {
      p <- cor.test(subdat[[x]], subdat[[y]], method = method, exact = FALSE)
      if (method == "pearson") {
        ci <- p$conf.int
      } else {
        ci <- tanh(atanh(p$estimate) + c(-1, 1) * qnorm(0.975) / sqrt(n - 3))
      }
      z <- c(p$estimate, ci, p$p.value)
      names(z) <- paste(c("cor", "lwr", "upr", "pv"), method, sep = "_")
      return(z)
    }))
    cbind(data.frame(var1 = y, var2 = x, n = n), t(w))
  }))
}))
```

```{r  tab_cor_moderators_export_table, echo=FALSE}
f <- "/tmp/tab_cor.xlsx"
write_xlsx(list(correlations = tab_cor), f)
embed_file(f, text = "Tableau corrélations (xlsx)")
f <- file.remove(f)
rm(f, tab_cor, X, Y)
```

<!-- BEGIN PSS10 -->
<details><summary>PSS10</summary>

```{r tab_cor_moderators}
Y <- c("PSS10_tot", "WHOQOL_d2_raw_score")
X <- c("PSS10_tot", "GSES_tot", "CD_RISC_tot", "MAAS_tot")
if (temps == 0.5) X <- c(X, "PTGI_tot")
tab_cor <- do.call(rbind, lapply(Y, function(y) {
  do.call(rbind, lapply(X, function(x) {
    subdat <- na.omit(hs[c(x, y)])
    n <- nrow(subdat)
    w <- do.call(base::c, lapply(c("pearson", "spearman"), function(method) {
      p <- cor.test(subdat[[x]], subdat[[y]], method = method, exact = FALSE)
      if (method == "pearson") {
        ci <- p$conf.int
      } else {
        ci <- tanh(atanh(p$estimate) + c(-1, 1) * qnorm(0.975) / sqrt(n - 3))
      }
      z <- c(p$estimate, ci, p$p.value)
      names(z) <- paste(c("cor", "lwr", "upr", "pv"), method, sep = "_")
      return(z)
    }))
    cbind(data.frame(var1 = y, var2 = x, n = n), t(w))
  }))
}))
```

```{r  tab_cor_moderators_export_table, echo=FALSE}
f <- "/tmp/tab_cor.xlsx"
write_xlsx(list(correlations = tab_cor), f)
embed_file(f, text = "Tableau corrélations (xlsx)")
f <- file.remove(f)
rm(f, tab_cor, X, Y)
```

</details>
<!-- END PSS10 -->

<!-- =============== Moderator effect of the variable GSES ================ -->

## Effets modérateur de la variable GSES

On observe une association entre la variable `GSES` et la variable 
`WHOQOL_d2_raw_score`

```{r fig_psy_gses, out.width="100%"}

subdat <- na.omit(hs[c("PSS14_tot", "WHOQOL_d2_raw_score", "GSES_tot")])
ggplot(subdat, aes(x = GSES_tot, y = WHOQOL_d2_raw_score)) +
  geom_point() +
  geom_smooth(formula = y ~ x, method = lm) +
  labs(caption = paste(nrow(subdat), "observations")) +
  theme_classic()

```

### Sans ajustement

La variable `GSES` modère la variable `PSS14`.

```{r lm_psy_pss14_gses}

m <- lm(WHOQOL_d2_raw_score  ~ PSS14_tot * GSES_tot, hs)
summary(m)

```

L'effet de la variable `PSS14` sur la variable `WHOQOL_PSY` diminue quand la
variable `GSES` augmente.

```{r fig_psy_pss14_gses, out.width="100%"}

expand.grid(
  PSS14_tot = subdat$PSS14_tot %>% {seq(min(.), max(.), length.out = 10^3)},
  GSES_tot = seq(10, 40, 5)
) %>%
  cbind(., pred_WHOQOL_d2_raw_score = predict(m, .)) %>%
  mutate(GSES_tot = factor(GSES_tot)) %>%
  ggplot(aes(x = PSS14_tot, y = pred_WHOQOL_d2_raw_score, color = GSES_tot)) +
  geom_line()

```

### Avec ajustement

Analyse ajustée pour l'âge et le sexe (l'utilisation de la variable sexe exclut
les répondants anglophones) :

```{r lm_psy_pss14_gses_adjusted}

m <- lm(WHOQOL_d2_raw_score  ~ PSS14_tot * GSES_tot + Sexe + Age,
        mutate(hs, Sexe = to_factor(Sexe)))
summary(m)

```

En considérant une interaction avec la variable sexe, on voit que la modération
peut dépendre de cette dernière :

```{r lm_psy_pss14_gses_adjusted_2}

m <- lm(WHOQOL_d2_raw_score  ~ PSS14_tot * GSES_tot * Sexe + Age,
        mutate(hs, Sexe = to_factor(Sexe)))
summary(m)

expand.grid(
  PSS14_tot = m$model$PSS14_tot %>% {seq(min(.), max(.), length.out = 10^3)},
  GSES_tot = seq(10, 40, 5),
  Age = median(m$model$Age),
  Sexe = c("une femme", "un homme")
) %>%
  cbind(., pred_WHOQOL_d2_raw_score = predict(m, .)) %>%
  mutate(GSES_tot = factor(GSES_tot)) %>%
  ggplot(aes(x = PSS14_tot, y = pred_WHOQOL_d2_raw_score, color = GSES_tot)) +
  geom_line() +
  facet_wrap(~ Sexe) +
  labs(caption = paste("Prediction pour l'âge médian :",
                       median(m$model$Age), "ans")) +
  theme(legend.position = "top") +
  guides(color = guide_legend(nrow = 1))

```

<!-- BEGIN PSS10 -->
<details><summary>PSS10</summary>

```{r fig_psy_gses, out.width="100%"}

subdat <- na.omit(hs[c("PSS10_tot", "WHOQOL_d2_raw_score", "GSES_tot")])
ggplot(subdat, aes(x = GSES_tot, y = WHOQOL_d2_raw_score)) +
  geom_point() +
  geom_smooth(formula = y ~ x, method = lm) +
  labs(caption = paste(nrow(subdat), "observations")) +
  theme_classic()

```

```{r lm_psy_pss10_gses}

m <- lm(WHOQOL_d2_raw_score  ~ PSS10_tot * GSES_tot, hs)
summary(m)

```

```{r fig_psy_pss10_gses, out.width="100%"}

expand.grid(
  PSS10_tot = subdat$PSS10_tot %>% {seq(min(.), max(.), length.out = 10^3)},
  GSES_tot = seq(10, 40, 5)
) %>%
  cbind(., pred_WHOQOL_d2_raw_score = predict(m, .)) %>%
  mutate(GSES_tot = factor(GSES_tot)) %>%
  ggplot(aes(x = PSS10_tot, y = pred_WHOQOL_d2_raw_score, color = GSES_tot)) +
  geom_line()

```

</details>
<!-- END PSS10 -->

```{r cleaning, echo=FALSE}
rm(m, subdat)
```

## Effet modérateur de la variable CD-RISC

On observe une association entre la variable `CD_RISC` et la variable 
`WHOQOL_d2_raw_score`

```{r fig_psy_cdrisc, out.width="100%"}

subdat <- na.omit(hs[c("PSS14_tot", "WHOQOL_d2_raw_score", "CD_RISC_tot")])
ggplot(subdat, aes(x = CD_RISC_tot, y = WHOQOL_d2_raw_score)) +
  geom_point() +
  geom_smooth(formula = y ~ x, method = lm) +
  labs(caption = paste(nrow(subdat), "observations")) +
  theme_classic()

```

### Sans ajustement

La variable `CD_RISC` modère la variable `PSS14`.

```{r lm_psy_pss14_cdrisc}

m <- lm(WHOQOL_d2_raw_score  ~ PSS14_tot * CD_RISC_tot, hs)
summary(m)

```

L'effet de la variable `PSS14` sur la variable `WHOQOL_PSY` diminue quand la
variable `CD_RISC` augmente.

```{r fig_psy_pss14_cdrisc, out.width="100%"}

expand.grid(
  PSS14_tot = subdat$PSS14_tot %>% {seq(min(.), max(.), length.out = 10^3)},
  CD_RISC_tot = seq(0, 40, 5)
) %>%
  cbind(., pred_WHOQOL_d2_raw_score = predict(m, .)) %>%
  mutate(CD_RISC_tot = factor(CD_RISC_tot)) %>%
  ggplot(aes(x = PSS14_tot, y = pred_WHOQOL_d2_raw_score,
             color = CD_RISC_tot)) +
  geom_line()

```

### Avec ajustement

Analyse ajustée pour l'âge et le sexe (l'utilisation de la variable sexe exclut
les répondants anglophones) :

```{r lm_psy_pss14_cdrisc_adjusted}

m <- lm(WHOQOL_d2_raw_score  ~ PSS14_tot * CD_RISC_tot + Sexe + Age,
        mutate(hs, Sexe = to_factor(Sexe)))
summary(m)

```

En considérant une interaction avec la variable sexe, on voit que la modération
peut dépendre de cette dernière :

```{r lm_psy_pss14_cdrisc_adjusted_2}

m <- lm(WHOQOL_d2_raw_score  ~ PSS14_tot * CD_RISC_tot * Sexe + Age,
        mutate(hs, Sexe = to_factor(Sexe)))
summary(m)

expand.grid(
  PSS14_tot = m$model$PSS14_tot %>% {seq(min(.), max(.), length.out = 10^3)},
  CD_RISC_tot = seq(0, 40, 5),
  Age = median(m$model$Age),
  Sexe = c("une femme", "un homme")
) %>%
  cbind(., pred_WHOQOL_d2_raw_score = predict(m, .)) %>%
  mutate(CD_RISC_tot = factor(CD_RISC_tot)) %>%
  ggplot(aes(x = PSS14_tot, y = pred_WHOQOL_d2_raw_score,
             color = CD_RISC_tot)) +
  geom_line() +
  facet_wrap(~ Sexe) +
  labs(caption = paste("Prediction pour l'âge médian :",
                       median(m$model$Age), "ans")) +
  theme(legend.position = "top") +
  guides(color = guide_legend(nrow = 1))

```

<!-- BEGIN PSS10 -->
<details><summary>PSS10</summary>

```{r fig_psy_cdrisc, out.width="100%"}

subdat <- na.omit(hs[c("PSS10_tot", "WHOQOL_d2_raw_score", "CD_RISC_tot")])
ggplot(subdat, aes(x = CD_RISC_tot, y = WHOQOL_d2_raw_score)) +
  geom_point() +
  geom_smooth(formula = y ~ x, method = lm) +
  labs(caption = paste(nrow(subdat), "observations")) +
  theme_classic()

```

```{r lm_psy_pss10_cdrisc}

m <- lm(WHOQOL_d2_raw_score  ~ PSS10_tot * CD_RISC_tot, hs)
summary(m)

```

```{r fig_psy_pss10_cdrisc, out.width="100%"}

expand.grid(
  PSS10_tot = subdat$PSS10_tot %>% {seq(min(.), max(.), length.out = 10^3)},
  CD_RISC_tot = seq(0, 40, 5)
) %>%
  cbind(., pred_WHOQOL_d2_raw_score = predict(m, .)) %>%
  mutate(CD_RISC_tot = factor(CD_RISC_tot)) %>%
  ggplot(aes(x = PSS10_tot, y = pred_WHOQOL_d2_raw_score,
             color = CD_RISC_tot)) +
  geom_line()

```

</details>
<!-- END PSS10 -->

```{r cleaning, echo=FALSE}
rm(m, subdat)
```

## Effet modérateur de la variable MAAS

On observe une association entre la variable `MAAS` et la variable 
`WHOQOL_d2_raw_score`

```{r fig_psy_maas, out.width="100%"}

subdat <- na.omit(hs[c("PSS14_tot", "WHOQOL_d2_raw_score", "MAAS_tot")])
ggplot(subdat, aes(x = MAAS_tot, y = WHOQOL_d2_raw_score)) +
  geom_point() +
  geom_smooth(formula = y ~ x, method = lm) +
  labs(caption = paste(nrow(subdat), "observations")) +
  theme_classic()

```

### Sans ajustement

La variable `MAAS` modère la variable `PSS14`.

```{r lm_psy_pss14_maas}

m <- lm(WHOQOL_d2_raw_score  ~ PSS14_tot * MAAS_tot, hs)
summary(m)

```

L'effet de la variable `PSS14` sur la variable `WHOQOL_PSY` diminue quand la
variable `MAAS` augmente.

```{r fig_psy_pss14_maas, out.width="100%"}

expand.grid(
  PSS14_tot = subdat$PSS14_tot %>% {seq(min(.), max(.), length.out = 10^3)},
  MAAS_tot = seq(20, 90, 10)
) %>%
  cbind(., pred_WHOQOL_d2_raw_score = predict(m, .)) %>%
  mutate(MAAS_tot = factor(MAAS_tot)) %>%
  ggplot(aes(x = PSS14_tot, y = pred_WHOQOL_d2_raw_score,
             color = MAAS_tot)) +
  geom_line()

```

### Avec ajustement

Analyse ajustée pour l'âge et le sexe (l'utilisation de la variable sexe exclut
les répondants anglophones) :

```{r lm_psy_pss14_maas_adjusted}

m <- lm(WHOQOL_d2_raw_score  ~ PSS14_tot * MAAS_tot + Sexe + Age,
        mutate(hs, Sexe = to_factor(Sexe)))
summary(m)

```

En considérant une interaction avec la variable sexe, on voit que la modération
peut dépendre de cette dernière :

```{r lm_psy_pss14_maas_adjusted_2}

m <- lm(WHOQOL_d2_raw_score  ~ PSS14_tot * MAAS_tot * Sexe + Age,
        mutate(hs, Sexe = to_factor(Sexe)))
summary(m)

expand.grid(
  PSS14_tot = m$model$PSS14_tot %>% {seq(min(.), max(.), length.out = 10^3)},
  MAAS_tot = seq(20, 90, 10),
  Age = median(m$model$Age),
  Sexe = c("une femme", "un homme")
) %>%
  cbind(., pred_WHOQOL_d2_raw_score = predict(m, .)) %>%
  mutate(MAAS_tot = factor(MAAS_tot)) %>%
  ggplot(aes(x = PSS14_tot, y = pred_WHOQOL_d2_raw_score,
             color = MAAS_tot)) +
  geom_line() +
  facet_wrap(~ Sexe) +
  labs(caption = paste("Prediction pour l'âge médian :",
                       median(m$model$Age), "ans")) +
  theme(legend.position = "top") +
  guides(color = guide_legend(nrow = 1))

```

<!-- BEGIN PSS10 -->
<details><summary>PSS10</summary>

```{r fig_psy_maas, out.width="100%"}

subdat <- na.omit(hs[c("PSS10_tot", "WHOQOL_d2_raw_score", "MAAS_tot")])
ggplot(subdat, aes(x = MAAS_tot, y = WHOQOL_d2_raw_score)) +
  geom_point() +
  geom_smooth(formula = y ~ x, method = lm) +
  labs(caption = paste(nrow(subdat), "observations")) +
  theme_classic()

```

```{r lm_psy_pss10_maas}

m <- lm(WHOQOL_d2_raw_score  ~ PSS10_tot * MAAS_tot, hs)
summary(m)

```

```{r fig_psy_pss10_maas, out.width="100%"}

expand.grid(
  PSS10_tot = subdat$PSS10_tot %>% {seq(min(.), max(.), length.out = 10^3)},
  MAAS_tot = seq(20, 90, 10)
) %>%
  cbind(., pred_WHOQOL_d2_raw_score = predict(m, .)) %>%
  mutate(MAAS_tot = factor(MAAS_tot)) %>%
  ggplot(aes(x = PSS10_tot, y = pred_WHOQOL_d2_raw_score,
             color = MAAS_tot)) +
  geom_line()

```

</details>
<!-- END PSS10 -->

```{r cleaning, echo=FALSE}
rm(m, subdat)
```

## Effet modérateur de la variable MSPSS (score global)

On observe une association entre la variable `MSPSS` et la variable 
`WHOQOL_d2_raw_score`

```{r fig_psy_mspss, out.width="100%"}

subdat <- na.omit(hs[c("PSS14_tot", "WHOQOL_d2_raw_score", "MSPSS_tot")])
ggplot(subdat, aes(x = MSPSS_tot, y = WHOQOL_d2_raw_score)) +
  geom_point() +
  geom_smooth(formula = y ~ x, method = lm) +
  labs(caption = paste(nrow(subdat), "observations")) +
  theme_classic()

```

### Sans ajustement

La variable `MSPSS` modère la variable `PSS14`.

```{r lm_psy_pss14_mspss}

m <- lm(WHOQOL_d2_raw_score  ~ PSS14_tot * MSPSS_tot, hs)
summary(m)

```

L'effet de la variable `PSS14` sur la variable `WHOQOL_PSY` diminue quand la
variable `MSPSS` augmente.

```{r fig_psy_pss14_mspss, out.width="100%"}

expand.grid(
  PSS14_tot = subdat$PSS14_tot %>% {seq(min(.), max(.), length.out = 10^3)},
  MSPSS_tot = 1:7
) %>%
  cbind(., pred_WHOQOL_d2_raw_score = predict(m, .)) %>%
  mutate(MSPSS_tot = factor(MSPSS_tot)) %>%
  ggplot(aes(x = PSS14_tot, y = pred_WHOQOL_d2_raw_score,
             color = MSPSS_tot)) +
  geom_line()

```

### Avec ajustement

Analyse ajustée pour l'âge et le sexe (l'utilisation de la variable sexe exclut
les répondants anglophones) :

```{r lm_psy_pss14_mspss_adjusted}

m <- lm(WHOQOL_d2_raw_score  ~ PSS14_tot * MSPSS_tot + Sexe + Age,
        mutate(hs, Sexe = to_factor(Sexe)))
summary(m)

```

En considérant une interaction avec la variable sexe, on voit que la modération
peut dépendre de cette dernière :

```{r lm_psy_pss14_mspss_adjusted_2}

m <- lm(WHOQOL_d2_raw_score  ~ PSS14_tot * MSPSS_tot * Sexe + Age,
        mutate(hs, Sexe = to_factor(Sexe)))
summary(m)

expand.grid(
  PSS14_tot = m$model$PSS14_tot %>% {seq(min(.), max(.), length.out = 10^3)},
  MSPSS_tot = 1:7,
  Age = median(m$model$Age),
  Sexe = c("une femme", "un homme")
) %>%
  cbind(., pred_WHOQOL_d2_raw_score = predict(m, .)) %>%
  mutate(MSPSS_tot = factor(MSPSS_tot)) %>%
  ggplot(aes(x = PSS14_tot, y = pred_WHOQOL_d2_raw_score,
             color = MSPSS_tot)) +
  geom_line() +
  facet_wrap(~ Sexe) +
  labs(caption = paste("Prediction pour l'âge médian :",
                       median(m$model$Age), "ans")) +
  theme(legend.position = "top") +
  guides(color = guide_legend(nrow = 1))

```

<!-- BEGIN PSS10 -->
<details><summary>PSS10</summary>
Les étudiants ayant eu le PSS10 n'ont pas eu le MSPSS.
</details>
<!-- END PSS10 -->

```{r cleaning, echo=FALSE}
rm(m, subdat)
```

## Effet modérateur de la variable `MSPSS_signif_other`

```{r fig_psy_mspss, out.width="100%"}

subdat <- na.omit(hs[c("PSS14_tot", "WHOQOL_d2_raw_score",
                       "MSPSS_signif_other")])
ggplot(subdat, aes(x = MSPSS_signif_other, y = WHOQOL_d2_raw_score)) +
  geom_point() +
  geom_smooth(formula = y ~ x, method = lm) +
  labs(caption = paste(nrow(subdat), "observations")) +
  theme_classic()

```

### Sans ajustement

```{r lm_psy_pss14_mspss}

m <- lm(WHOQOL_d2_raw_score  ~ PSS14_tot * MSPSS_signif_other, hs)
summary(m)

```

```{r fig_psy_pss14_mspss, out.width="100%"}

expand.grid(
  PSS14_tot = subdat$PSS14_tot %>% {seq(min(.), max(.), length.out = 10^3)},
  MSPSS_signif_other = 1:7
) %>%
  cbind(., pred_WHOQOL_d2_raw_score = predict(m, .)) %>%
  mutate(MSPSS_signif_other = factor(MSPSS_signif_other)) %>%
  ggplot(aes(x = PSS14_tot, y = pred_WHOQOL_d2_raw_score,
             color = MSPSS_signif_other)) +
  geom_line()

```

### Avec ajustement

Analyse ajustée pour l'âge et le sexe (l'utilisation de la variable sexe exclut
les répondants anglophones) :

```{r lm_psy_pss14_mspss_adjusted}

m <- lm(WHOQOL_d2_raw_score  ~ PSS14_tot * MSPSS_signif_other + Sexe + Age,
        mutate(hs, Sexe = to_factor(Sexe)))
summary(m)

```

```{r lm_psy_pss14_mspss_adjusted_2}

m <- lm(WHOQOL_d2_raw_score  ~ PSS14_tot * MSPSS_signif_other * Sexe + Age,
        mutate(hs, Sexe = to_factor(Sexe)))
summary(m)

expand.grid(
  PSS14_tot = m$model$PSS14_tot %>% {seq(min(.), max(.), length.out = 10^3)},
  MSPSS_signif_other = 1:7,
  Age = median(m$model$Age),
  Sexe = c("une femme", "un homme")
) %>%
  cbind(., pred_WHOQOL_d2_raw_score = predict(m, .)) %>%
  mutate(MSPSS_signif_other = factor(MSPSS_signif_other)) %>%
  ggplot(aes(x = PSS14_tot, y = pred_WHOQOL_d2_raw_score,
             color = MSPSS_signif_other)) +
  geom_line() +
  facet_wrap(~ Sexe) +
  labs(caption = paste("Prediction pour l'âge médian :",
                       median(m$model$Age), "ans")) +
  theme(legend.position = "top") +
  guides(color = guide_legend(nrow = 1))

```

```{r cleaning, echo=FALSE}
rm(m, subdat)
```

## Effet modérateur de la variable `MSPSS_family`

```{r fig_psy_mspss, out.width="100%"}

subdat <- na.omit(hs[c("PSS14_tot", "WHOQOL_d2_raw_score",
                       "MSPSS_family")])
ggplot(subdat, aes(x = MSPSS_family, y = WHOQOL_d2_raw_score)) +
  geom_point() +
  geom_smooth(formula = y ~ x, method = lm) +
  labs(caption = paste(nrow(subdat), "observations")) +
  theme_classic()

```

### Sans ajustement

```{r lm_psy_pss14_mspss}

m <- lm(WHOQOL_d2_raw_score  ~ PSS14_tot * MSPSS_family, hs)
summary(m)

```

```{r fig_psy_pss14_mspss, out.width="100%"}

expand.grid(
  PSS14_tot = subdat$PSS14_tot %>% {seq(min(.), max(.), length.out = 10^3)},
  MSPSS_family = 1:7
) %>%
  cbind(., pred_WHOQOL_d2_raw_score = predict(m, .)) %>%
  mutate(MSPSS_family = factor(MSPSS_family)) %>%
  ggplot(aes(x = PSS14_tot, y = pred_WHOQOL_d2_raw_score,
             color = MSPSS_family)) +
  geom_line()

```

### Avec ajustement

Analyse ajustée pour l'âge et le sexe (l'utilisation de la variable sexe exclut
les répondants anglophones) :

```{r lm_psy_pss14_mspss_adjusted}

m <- lm(WHOQOL_d2_raw_score  ~ PSS14_tot * MSPSS_family + Sexe + Age,
        mutate(hs, Sexe = to_factor(Sexe)))
summary(m)

```

```{r lm_psy_pss14_mspss_adjusted_2}

m <- lm(WHOQOL_d2_raw_score  ~ PSS14_tot * MSPSS_family * Sexe + Age,
        mutate(hs, Sexe = to_factor(Sexe)))
summary(m)

expand.grid(
  PSS14_tot = m$model$PSS14_tot %>% {seq(min(.), max(.), length.out = 10^3)},
  MSPSS_family = 1:7,
  Age = median(m$model$Age),
  Sexe = c("une femme", "un homme")
) %>%
  cbind(., pred_WHOQOL_d2_raw_score = predict(m, .)) %>%
  mutate(MSPSS_family = factor(MSPSS_family)) %>%
  ggplot(aes(x = PSS14_tot, y = pred_WHOQOL_d2_raw_score,
             color = MSPSS_family)) +
  geom_line() +
  facet_wrap(~ Sexe) +
  labs(caption = paste("Prediction pour l'âge médian :",
                       median(m$model$Age), "ans")) +
  theme(legend.position = "top") +
  guides(color = guide_legend(nrow = 1))

```

```{r cleaning, echo=FALSE}
rm(m, subdat)
```

## Effet modérateur de la variable `MSPSS_friends`

```{r fig_psy_mspss, out.width="100%"}

subdat <- na.omit(hs[c("PSS14_tot", "WHOQOL_d2_raw_score",
                       "MSPSS_friends")])
ggplot(subdat, aes(x = MSPSS_friends, y = WHOQOL_d2_raw_score)) +
  geom_point() +
  geom_smooth(formula = y ~ x, method = lm) +
  labs(caption = paste(nrow(subdat), "observations")) +
  theme_classic()

```

### Sans ajustement

```{r lm_psy_pss14_mspss}

m <- lm(WHOQOL_d2_raw_score  ~ PSS14_tot * MSPSS_friends, hs)
summary(m)

```

```{r fig_psy_pss14_mspss, out.width="100%"}

expand.grid(
  PSS14_tot = subdat$PSS14_tot %>% {seq(min(.), max(.), length.out = 10^3)},
  MSPSS_friends = 1:7
) %>%
  cbind(., pred_WHOQOL_d2_raw_score = predict(m, .)) %>%
  mutate(MSPSS_friends = factor(MSPSS_friends)) %>%
  ggplot(aes(x = PSS14_tot, y = pred_WHOQOL_d2_raw_score,
             color = MSPSS_friends)) +
  geom_line()

```

### Avec ajustement

Analyse ajustée pour l'âge et le sexe (l'utilisation de la variable sexe exclut
les répondants anglophones) :

```{r lm_psy_pss14_mspss_adjusted}

m <- lm(WHOQOL_d2_raw_score  ~ PSS14_tot * MSPSS_friends + Sexe + Age,
        mutate(hs, Sexe = to_factor(Sexe)))
summary(m)

```

```{r lm_psy_pss14_mspss_adjusted_2}

m <- lm(WHOQOL_d2_raw_score  ~ PSS14_tot * MSPSS_friends * Sexe + Age,
        mutate(hs, Sexe = to_factor(Sexe)))
summary(m)

expand.grid(
  PSS14_tot = m$model$PSS14_tot %>% {seq(min(.), max(.), length.out = 10^3)},
  MSPSS_friends = 1:7,
  Age = median(m$model$Age),
  Sexe = c("une femme", "un homme")
) %>%
  cbind(., pred_WHOQOL_d2_raw_score = predict(m, .)) %>%
  mutate(MSPSS_friends = factor(MSPSS_friends)) %>%
  ggplot(aes(x = PSS14_tot, y = pred_WHOQOL_d2_raw_score,
             color = MSPSS_friends)) +
  geom_line() +
  facet_wrap(~ Sexe) +
  labs(caption = paste("Prediction pour l'âge médian :",
                       median(m$model$Age), "ans")) +
  theme(legend.position = "top") +
  guides(color = guide_legend(nrow = 1))

```

```{r cleaning, echo=FALSE}
rm(m, subdat)
```

<!-- BEGIN PTGI -->

## Effet modérateur de la variable PTGI (score global)

On observe pas d'association entre la variable `PTGI` et la variable 
`WHOQOL_d2_raw_score`

```{r fig_psy_ptgi, out.width="100%"}

subdat <- na.omit(hs[c("PSS14_tot", "WHOQOL_d2_raw_score", "PTGI_tot")])
ggplot(subdat, aes(x = PTGI_tot, y = WHOQOL_d2_raw_score)) +
  geom_point() +
  geom_smooth(formula = y ~ x, method = lm) +
  labs(caption = paste(nrow(subdat), "observations")) +
  theme_classic()

```

### Sans ajustement

La variable `PTGI` ne modère pas la variable `PSS14`.

```{r lm_psy_pss14_ptgi}

m <- lm(WHOQOL_d2_raw_score  ~ PSS14_tot * PTGI_tot, hs)
summary(m)

```

```{r fig_psy_pss14_ptgi, out.width="100%"}

expand.grid(
  PSS14_tot = subdat$PSS14_tot %>% {seq(min(.), max(.), length.out = 10^3)},
  PTGI_tot = 1:7
) %>%
  cbind(., pred_WHOQOL_d2_raw_score = predict(m, .)) %>%
  mutate(PTGI_tot = factor(PTGI_tot)) %>%
  ggplot(aes(x = PSS14_tot, y = pred_WHOQOL_d2_raw_score,
             color = PTGI_tot)) +
  geom_line()

```

### Avec ajustement

Analyse ajustée pour l'âge et le sexe :

```{r lm_psy_pss14_ptgi_adjusted}

m <- lm(WHOQOL_d2_raw_score  ~ PSS14_tot * PTGI_tot + Sexe + Age,
        mutate(hs, Sexe = to_factor(Sexe)))
summary(m)

```

```{r cleaning, echo=FALSE}
rm(m, subdat)
```

## Effet modérateur de la variable `PTGI_new_possibilities`

On observe pas d'association entre la variable `PTGI_new_possibilities` et la
variable `WHOQOL_d2_raw_score`

```{r fig_psy_ptgi, out.width="100%"}

subdat <- na.omit(hs[c("PSS14_tot", "WHOQOL_d2_raw_score",
                       "PTGI_new_possibilities")])
ggplot(subdat, aes(x = PTGI_new_possibilities, y = WHOQOL_d2_raw_score)) +
  geom_point() +
  geom_smooth(formula = y ~ x, method = lm) +
  labs(caption = paste(nrow(subdat), "observations")) +
  theme_classic()

```

### Sans ajustement

La variable `PTGI_new_possibilities` ne modère pas la variable `PSS14`.

```{r lm_psy_pss14_ptgi}

m <- lm(WHOQOL_d2_raw_score  ~ PSS14_tot * PTGI_new_possibilities, hs)
summary(m)

```

```{r fig_psy_pss14_ptgi, out.width="100%"}

expand.grid(
  PSS14_tot = subdat$PSS14_tot %>% {seq(min(.), max(.), length.out = 10^3)},
  PTGI_new_possibilities = 1:7
) %>%
  cbind(., pred_WHOQOL_d2_raw_score = predict(m, .)) %>%
  mutate(PTGI_new_possibilities = factor(PTGI_new_possibilities)) %>%
  ggplot(aes(x = PSS14_tot, y = pred_WHOQOL_d2_raw_score,
             color = PTGI_new_possibilities)) +
  geom_line()

```

### Avec ajustement

Analyse ajustée pour l'âge et le sexe :

```{r lm_psy_pss14_ptgi_adjusted}

m <- lm(WHOQOL_d2_raw_score  ~ PSS14_tot * PTGI_new_possibilities + Sexe + Age,
        mutate(hs, Sexe = to_factor(Sexe)))
summary(m)

```

```{r cleaning, echo=FALSE}
rm(m, subdat)
```

## Effet modérateur de la variable `PTGI_relating_to_others`

On observe pas d'association entre la variable `PTGI_relating_to_others` et la
variable `WHOQOL_d2_raw_score`

```{r fig_psy_ptgi, out.width="100%"}

subdat <- na.omit(hs[c("PSS14_tot", "WHOQOL_d2_raw_score",
                       "PTGI_relating_to_others")])
ggplot(subdat, aes(x = PTGI_relating_to_others, y = WHOQOL_d2_raw_score)) +
  geom_point() +
  geom_smooth(formula = y ~ x, method = lm) +
  labs(caption = paste(nrow(subdat), "observations")) +
  theme_classic()

```

### Sans ajustement

La variable `PTGI` ne modère pas la variable `PSS14`.

```{r lm_psy_pss14_ptgi}

m <- lm(WHOQOL_d2_raw_score  ~ PSS14_tot * PTGI_relating_to_others, hs)
summary(m)

```

```{r fig_psy_pss14_ptgi, out.width="100%"}

expand.grid(
  PSS14_tot = subdat$PSS14_tot %>% {seq(min(.), max(.), length.out = 10^3)},
  PTGI_relating_to_others = 1:7
) %>%
  cbind(., pred_WHOQOL_d2_raw_score = predict(m, .)) %>%
  mutate(PTGI_relating_to_others = factor(PTGI_relating_to_others)) %>%
  ggplot(aes(x = PSS14_tot, y = pred_WHOQOL_d2_raw_score,
             color = PTGI_relating_to_others)) +
  geom_line()

```

### Avec ajustement

Analyse ajustée pour l'âge et le sexe :

```{r lm_psy_pss14_ptgi_adjusted}

m <- lm(WHOQOL_d2_raw_score  ~ PSS14_tot * PTGI_relating_to_others + Sexe +
          Age, mutate(hs, Sexe = to_factor(Sexe)))
summary(m)

```

```{r cleaning, echo=FALSE}
rm(m, subdat)
```

## Effet modérateur de la variable `PTGI_personal_strength`

On observe pas d'association entre la variable `PTGI_personal_strength` et la
variable `WHOQOL_d2_raw_score`

```{r fig_psy_ptgi, out.width="100%"}

subdat <- na.omit(hs[c("PSS14_tot", "WHOQOL_d2_raw_score",
                       "PTGI_personal_strength")])
ggplot(subdat, aes(x = PTGI_personal_strength, y = WHOQOL_d2_raw_score)) +
  geom_point() +
  geom_smooth(formula = y ~ x, method = lm) +
  labs(caption = paste(nrow(subdat), "observations")) +
  theme_classic()

```

### Sans ajustement

La variable `PTGI` ne modère pas la variable `PSS14`.

```{r lm_psy_pss14_ptgi}

m <- lm(WHOQOL_d2_raw_score  ~ PSS14_tot * PTGI_personal_strength, hs)
summary(m)

```

```{r fig_psy_pss14_ptgi, out.width="100%"}

expand.grid(
  PSS14_tot = subdat$PSS14_tot %>% {seq(min(.), max(.), length.out = 10^3)},
  PTGI_personal_strength = 1:7
) %>%
  cbind(., pred_WHOQOL_d2_raw_score = predict(m, .)) %>%
  mutate(PTGI_personal_strength = factor(PTGI_personal_strength)) %>%
  ggplot(aes(x = PSS14_tot, y = pred_WHOQOL_d2_raw_score,
             color = PTGI_personal_strength)) +
  geom_line()

```

### Avec ajustement

Analyse ajustée pour l'âge et le sexe :

```{r lm_psy_pss14_ptgi_adjusted}

m <- lm(WHOQOL_d2_raw_score  ~ PSS14_tot * PTGI_personal_strength + Sexe + Age,
        mutate(hs, Sexe = to_factor(Sexe)))
summary(m)

```

```{r cleaning, echo=FALSE}
rm(m, subdat)
```

## Effet modérateur de la variable `PTGI_appreciation_of_life`

On observe pas d'association entre la variable `PTGI_appreciation_of_life` et
la variable `WHOQOL_d2_raw_score`

```{r fig_psy_ptgi, out.width="100%"}

subdat <- na.omit(hs[c("PSS14_tot", "WHOQOL_d2_raw_score",
                       "PTGI_appreciation_of_life")])
ggplot(subdat, aes(x = PTGI_appreciation_of_life, y = WHOQOL_d2_raw_score)) +
  geom_point() +
  geom_smooth(formula = y ~ x, method = lm) +
  labs(caption = paste(nrow(subdat), "observations")) +
  theme_classic()

```

### Sans ajustement

La variable `PTGI` ne modère pas la variable `PSS14`.

```{r lm_psy_pss14_ptgi}

m <- lm(WHOQOL_d2_raw_score  ~ PSS14_tot * PTGI_appreciation_of_life, hs)
summary(m)

```

```{r fig_psy_pss14_ptgi, out.width="100%"}

expand.grid(
  PSS14_tot = subdat$PSS14_tot %>% {seq(min(.), max(.), length.out = 10^3)},
  PTGI_appreciation_of_life = 1:7
) %>%
  cbind(., pred_WHOQOL_d2_raw_score = predict(m, .)) %>%
  mutate(PTGI_appreciation_of_life = factor(PTGI_appreciation_of_life)) %>%
  ggplot(aes(x = PSS14_tot, y = pred_WHOQOL_d2_raw_score,
             color = PTGI_appreciation_of_life)) +
  geom_line()

```

### Avec ajustement

Analyse ajustée pour l'âge et le sexe :

```{r lm_psy_pss14_ptgi_adjusted}

m <- lm(WHOQOL_d2_raw_score  ~ PSS14_tot * PTGI_appreciation_of_life + Sexe + Age,
        mutate(hs, Sexe = to_factor(Sexe)))
summary(m)

```

```{r cleaning, echo=FALSE}
rm(m, subdat)
```

## Effet modérateur de la variable `PTGI_spiritual_change`

On observe pas d'association entre la variable `PTGI_spiritual_change` et la
variable `WHOQOL_d2_raw_score`

```{r fig_psy_ptgi, out.width="100%"}

subdat <- na.omit(hs[c("PSS14_tot", "WHOQOL_d2_raw_score",
                       "PTGI_spiritual_change")])
ggplot(subdat, aes(x = PTGI_spiritual_change, y = WHOQOL_d2_raw_score)) +
  geom_point() +
  geom_smooth(formula = y ~ x, method = lm) +
  labs(caption = paste(nrow(subdat), "observations")) +
  theme_classic()

```

### Sans ajustement

La variable `PTGI` ne modère pas la variable `PSS14`.

```{r lm_psy_pss14_ptgi}

m <- lm(WHOQOL_d2_raw_score  ~ PSS14_tot * PTGI_spiritual_change, hs)
summary(m)

```

```{r fig_psy_pss14_ptgi, out.width="100%"}

expand.grid(
  PSS14_tot = subdat$PSS14_tot %>% {seq(min(.), max(.), length.out = 10^3)},
  PTGI_spiritual_change = 1:7
) %>%
  cbind(., pred_WHOQOL_d2_raw_score = predict(m, .)) %>%
  mutate(PTGI_spiritual_change = factor(PTGI_spiritual_change)) %>%
  ggplot(aes(x = PSS14_tot, y = pred_WHOQOL_d2_raw_score,
             color = PTGI_spiritual_change)) +
  geom_line()

```

### Avec ajustement

Analyse ajustée pour l'âge et le sexe :

```{r lm_psy_pss14_ptgi_adjusted}

m <- lm(WHOQOL_d2_raw_score  ~ PSS14_tot * PTGI_spiritual_change + Sexe + Age,
        mutate(hs, Sexe = to_factor(Sexe)))
summary(m)

```

```{r cleaning, echo=FALSE}
rm(m, subdat)
```

<!-- END PTGI -->

## Corrélation entre les variables modératrices

Les variables modératrices sont corrélées entre elles et ont sensiblement toute
le même effet sur la relation entre les variables `PSS14` et `WHOQOL_PSY`.

```{r fig_cor_moderators, out.width="100%"}
X <- c("PSS14_tot", "WHOQOL_d2_raw_score", "GSES_tot", "CD_RISC_tot",
       "MAAS_tot", "MSPSS_tot")
if (!all(is.na(hs$PTGI_tot))) {
  X <- c(X, "PTGI_tot")
}
subdat <- na.omit(hs[X])
fig <- ggpairs(subdat, progress = FALSE) +
  labs(caption = paste("Nombre d'observations :", nrow(subdat)))
fig
```

```{r export_fig_cor_moderators, echo=FALSE}
f <- "/tmp/fig_cor_moderators.pdf"
cairo_pdf(f, width = 14, height = 14, onefile = TRUE)
print(fig)
garbage <- dev.off()
embed_file(f, text = "Figure (pdf)")
f <- file.remove(f)
rm(f, fig, garbage, subdat)
```

<!-- BEGIN PSS10 -->
<details><summary>PSS10</summary>

```{r fig_cor_moderators, out.width="100%"}
subdat <- na.omit(hs[c("PSS10_tot", "WHOQOL_d2_raw_score", "GSES_tot",
                       "CD_RISC_tot", "MAAS_tot", "MSPSS_tot")])
fig <- ggpairs(subdat, progress = FALSE) +
  labs(caption = paste("Nombre d'observations :", nrow(subdat)))
fig
```

```{r export_fig_cor_moderators, echo=FALSE}
f <- "/tmp/fig_cor_moderators.pdf"
cairo_pdf(f, width = 14, height = 14, onefile = TRUE)
print(fig)
garbage <- dev.off()
embed_file(f, text = "Figure (pdf)")
f <- file.remove(f)
rm(f, fig, garbage, subdat)
```

</details>
<!-- END PSS10 -->

## Modèle multivariable (sans PTGI)

### Sans ajustement

```{r multivariable_model_without_ptgi}
X <- c("GSES_tot", "CD_RISC_tot", "MAAS_tot", "MSPSS_tot")
fml <- paste("WHOQOL_d2_raw_score  ~",
             paste(paste("PSS14_tot *", X), collapse = " + "))
fml <- as.formula(fml)
complete_cases <- na.omit(hs[c("WHOQOL_d2_raw_score", "PSS14_tot", X)])
m <- do.call("lm", list(formula = fml, data = quote(complete_cases)))
summary(m)
if (nrow(hs) > nrow(complete_cases)) {
  print(paste(nrow(hs) - nrow(complete_cases),
              "observation(s) deleted due to missingness"))
}
ggplot(m) +
  stat_qq(aes(sample = .stdresid)) +
  geom_abline() +
  labs(x = "Theoretical Quantiles", y = "Standardized Residuals",
       title = "Normal Q-Q Plot") +
  theme_classic()
```

Sélection des variables (pour info) :

```{r stepwise_model_without_ptgi}
s <- step(m, trace = FALSE)
summary(s)
```

```{r multivariable_model_table_without_ptgi}
Merge <- function(x, y) merge(x, y, by = "coef", all = TRUE, sort = FALSE)
reg_tbl <- Reduce(Merge, lapply(c(X, "multivar", "stepwise"), function(x) {
  if (x == "multivar") {
    m0 <- m
  } else if (x == "stepwise") {
    m0 <- s
  } else {
    fml <- as.formula(paste("WHOQOL_d2_raw_score  ~ PSS14_tot *", x))
    m0 <- lm(fml, m$model)
  }
  beta <- coef(m0)
  pv <- coef(summary(m0))[, "Pr(>|t|)"]
  tbl <- cbind(data.frame(coef = names(beta), beta = beta),
               confint(m0), pval =pv)
  rownames(tbl) <- NULL
  colnames(tbl)[-1] <-
    paste0(colnames(tbl)[-1], " (", sub("_tot$", "", x), ")")
  return(tbl)
}))
```

```{r multivariable_model_export_table_without_ptgi, echo=FALSE}
f <- "/tmp/multivariable_model.xlsx"
write_xlsx(list(multivariable_model = reg_tbl), f)
embed_file(f, text = "multivariable_model (xlsx)")
f <- file.remove(f)
rm(X, fml, m, reg_tbl, f)
```

### Avec ajustement

```{r multivariable_model_without_ptgi}
X <- c("GSES_tot", "CD_RISC_tot", "MAAS_tot", "MSPSS_tot", "Sexe", "Age")
fml <- paste("WHOQOL_d2_raw_score  ~",
             paste(paste("PSS14_tot *", X), collapse = " + "))
fml <- as.formula(fml)
complete_cases <- na.omit(hs[c("WHOQOL_d2_raw_score", "PSS14_tot", X)])
m <- do.call("lm", list(formula = fml, data = quote(complete_cases)))
summary(m)
if (nrow(hs) > nrow(complete_cases)) {
  print(paste(nrow(hs) - nrow(complete_cases),
              "observation(s) deleted due to missingness"))
}
ggplot(m) +
  stat_qq(aes(sample = .stdresid)) +
  geom_abline() +
  labs(x = "Theoretical Quantiles", y = "Standardized Residuals",
       title = "Normal Q-Q Plot") +
  theme_classic()
```

Sélection des variables (pour info) :

```{r stepwise_model_without_ptgi}
s <- step(m, trace = FALSE)
summary(s)
```

```{r multivariable_model_table_without_ptgi}
Merge <- function(x, y) merge(x, y, by = "coef", all = TRUE, sort = FALSE)
reg_tbl <- Reduce(Merge, lapply(c(X, "multivar", "stepwise"), function(x) {
  if (x == "multivar") {
    m0 <- m
  } else if (x == "stepwise") {
    m0 <- s
  } else {
    fml <- as.formula(paste("WHOQOL_d2_raw_score  ~ PSS14_tot *", x))
    m0 <- lm(fml, m$model)
  }
  beta <- coef(m0)
  pv <- coef(summary(m0))[, "Pr(>|t|)"]
  tbl <- cbind(data.frame(coef = names(beta), beta = beta),
               confint(m0), pval =pv)
  rownames(tbl) <- NULL
  colnames(tbl)[-1] <-
    paste0(colnames(tbl)[-1], " (", sub("_tot$", "", x), ")")
  return(tbl)
}))
```

```{r multivariable_model_export_table_without_ptgi, echo=FALSE}
f <- "/tmp/multivariable_model.xlsx"
write_xlsx(list(multivariable_model = reg_tbl), f)
embed_file(f, text = "multivariable_model (xlsx)")
f <- file.remove(f)
rm(X, fml, m, reg_tbl, f)
```

<!-- BEGIN PSS10 -->
<details><summary>PSS10</summary>

```{r multivariable_model}
X <- c("GSES_tot", "CD_RISC_tot", "MAAS_tot")
fml <- paste("WHOQOL_d2_raw_score  ~",
             paste(paste("PSS10_tot *", X), collapse = " + "))
fml <- as.formula(fml)
m <- do.call("lm", list(formula = fml, data = quote(hs)))
summary(m)
#s <- step(m, direction = "both", trace = FALSE)
#summary(s)
ggplot(m) +
  stat_qq(aes(sample = .stdresid)) +
  geom_abline() +
  labs(x = "Theoretical Quantiles", y = "Standardized Residuals",
       title = "Normal Q-Q Plot") +
  theme_classic()
```

Sélection des variables (pour info) :

```{r}
s <- step(m, trace = FALSE)
summary(s)
```

```{r multivariable_model_table}
Merge <- function(x, y) merge(x, y, by = "coef", all = TRUE, sort = FALSE)
reg_tbl <- Reduce(Merge, lapply(c(X, "multivar", "stepwise"), function(x) {
  if (x == "multivar") {
    m0 <- m
  } else if (x == "stepwise") {
    m0 <- s
  } else {
    fml <- as.formula(paste("WHOQOL_d2_raw_score  ~ PSS10_tot *", x))
    m0 <- lm(fml, m$model)
  }
  beta <- coef(m0)
  pv <- coef(summary(m0))[, "Pr(>|t|)"]
  tbl <- cbind(data.frame(coef = names(beta), beta = beta),
               confint(m0), pval =pv)
  rownames(tbl) <- NULL
  colnames(tbl)[-1] <-
    paste0(colnames(tbl)[-1], " (", sub("_tot$", "", x), ")")
  return(tbl)
}))
```

```{r multivariable_model_export_table, echo=FALSE}
f <- "/tmp/multivariable_model_pss10.xlsx"
write_xlsx(list(multivariable_model = reg_tbl), f)
embed_file(f, text = "multivariable_model_pss10 (xlsx)")
f <- file.remove(f)
rm(X, fml, m, reg_tbl, f)
```

</details>
<!-- END PSS10 -->

<!-- BEGIN PTGI -->

## Modèle multivariable (avec PTGI)

### Sans ajustement

```{r multivariable_model_with_ptgi}
X <- c("GSES_tot", "CD_RISC_tot", "MAAS_tot", "MSPSS_tot", "PTGI_tot")
fml <- paste("WHOQOL_d2_raw_score  ~",
             paste(paste("PSS14_tot *", X), collapse = " + "))
fml <- as.formula(fml)
complete_cases <- na.omit(hs[c("WHOQOL_d2_raw_score", "PSS14_tot", X)])
m <- do.call("lm", list(formula = fml, data = quote(complete_cases)))
summary(m)
if (nrow(hs) > nrow(complete_cases)) {
  print(paste(nrow(hs) - nrow(complete_cases),
              "observation(s) deleted due to missingness"))
}
ggplot(m) +
  stat_qq(aes(sample = .stdresid)) +
  geom_abline() +
  labs(x = "Theoretical Quantiles", y = "Standardized Residuals",
       title = "Normal Q-Q Plot") +
  theme_classic()
```

Sélection des variables (pour info) :

```{r stepwise_model_with_ptgi}
s <- step(m, trace = FALSE)
summary(s)
```

```{r multivariable_model_table_with_ptgi}
Merge <- function(x, y) merge(x, y, by = "coef", all = TRUE, sort = FALSE)
reg_tbl <- Reduce(Merge, lapply(c(X, "multivar", "stepwise"), function(x) {
  if (x == "multivar") {
    m0 <- m
  } else if (x == "stepwise") {
    m0 <- s
  } else {
    fml <- as.formula(paste("WHOQOL_d2_raw_score  ~ PSS14_tot *", x))
    m0 <- lm(fml, m$model)
  }
  beta <- coef(m0)
  pv <- coef(summary(m0))[, "Pr(>|t|)"]
  tbl <- cbind(data.frame(coef = names(beta), beta = beta),
               confint(m0), pval =pv)
  rownames(tbl) <- NULL
  colnames(tbl)[-1] <-
    paste0(colnames(tbl)[-1], " (", sub("_tot$", "", x), ")")
  return(tbl)
}))
```

```{r multivariable_model_export_table, echo=FALSE}
f <- "/tmp/multivariable_model.xlsx"
write_xlsx(list(multivariable_model = reg_tbl), f)
embed_file(f, text = "multivariable_model (xlsx)")
f <- file.remove(f)
rm(X, fml, m, reg_tbl, f)
```

### Avec ajustement

```{r multivariable_model_with_ptgi}
X <- c("GSES_tot", "CD_RISC_tot", "MAAS_tot", "MSPSS_tot", "PTGI_tot",
       "Sexe", "Age")
fml <- paste("WHOQOL_d2_raw_score  ~",
             paste(paste("PSS14_tot *", X), collapse = " + "))
fml <- as.formula(fml)
complete_cases <- na.omit(hs[c("WHOQOL_d2_raw_score", "PSS14_tot", X)])
m <- do.call("lm", list(formula = fml, data = quote(complete_cases)))
summary(m)
if (nrow(hs) > nrow(complete_cases)) {
  print(paste(nrow(hs) - nrow(complete_cases),
              "observation(s) deleted due to missingness"))
}
ggplot(m) +
  stat_qq(aes(sample = .stdresid)) +
  geom_abline() +
  labs(x = "Theoretical Quantiles", y = "Standardized Residuals",
       title = "Normal Q-Q Plot") +
  theme_classic()
```

Sélection des variables (pour info) :

```{r stepwise_model_with_ptgi}
s <- step(m, trace = FALSE)
summary(s)
```

```{r multivariable_model_table_with_ptgi}
Merge <- function(x, y) merge(x, y, by = "coef", all = TRUE, sort = FALSE)
reg_tbl <- Reduce(Merge, lapply(c(X, "multivar", "stepwise"), function(x) {
  if (x == "multivar") {
    m0 <- m
  } else if (x == "stepwise") {
    m0 <- s
  } else {
    fml <- as.formula(paste("WHOQOL_d2_raw_score  ~ PSS14_tot *", x))
    m0 <- lm(fml, m$model)
  }
  beta <- coef(m0)
  pv <- coef(summary(m0))[, "Pr(>|t|)"]
  tbl <- cbind(data.frame(coef = names(beta), beta = beta),
               confint(m0), pval =pv)
  rownames(tbl) <- NULL
  colnames(tbl)[-1] <-
    paste0(colnames(tbl)[-1], " (", sub("_tot$", "", x), ")")
  return(tbl)
}))
```

```{r multivariable_model_export_table, echo=FALSE}
f <- "/tmp/multivariable_model.xlsx"
write_xlsx(list(multivariable_model = reg_tbl), f)
embed_file(f, text = "multivariable_model (xlsx)")
f <- file.remove(f)
rm(X, fml, m, reg_tbl, f)
```

<!-- END PTGI -->

<!-- BEGIN PTGI -->

## Scores `PTGI` en fonction des Questions `COVID19_3` ou `COVID19_4`

```{r}

do.call(rbind, lapply(grep("^PTGI", names(hs), value = TRUE), function(y) {
  do.call(rbind, lapply(paste0("COVID19_", 3:4), function(x) {
    fml <- as.formula(paste(y, "~", x))
    N <- length
    fcts <- c("N", "mean", "sd", "median", "IQR", "min", "max")
    Merge <- function(u, v) merge(u, v, by = "Exposition value")
    r <- Reduce(Merge, lapply(fcts, function(fct) {
      r <- aggregate(fml, hs, get(fct))
      names(r) <- c("Exposition value", fct)
      return(r)
    }))
    pv <- t.test(fml, hs)$p.value
    cbind(Outcome = y, `Exposition variable` = x, r, ttest_pval = c(pv, NA))
  }))
})) %>%
  kable(digits = 2)

```

<!-- END PTGI -->

## Flourish index

### Descriptive statistics

```{r fi_descr_stat}
tbl <- do.call(rbind, lapply(1:12, function(i) {
  v <- paste0("HFI", i)
  x <- na.omit(hs[[v]])
  d <- as.integer(ceiling(i / 2))
  data.frame(Question = i, Dimension = d, Variable = v, Nobs = length(x),
             Mean = mean(x), SD = sd(x))
}))
kable(tbl, digits = 2)
```

```{r fi_descr_stat_exp_tbl, echo=FALSE}
f <- "/tmp/flourish_index_descr_stat.xlsx"
write_xlsx(list(fi_descr_stat = tbl), f)
embed_file(f, text = "Flourish index - Descriptive statistics (xlsx)")
f <- file.remove(f)
rm(tbl, f)
```

### Correlation matrix

```{r fi_cor_mat}
subdat <- na.omit(hs[paste0("HFI", 1:12)])
subdat <- as.data.frame(lapply(subdat, as.numeric))
tbl <- cor(subdat)
kable(tbl, digits = 2)
```

```{r fi_cor_mat_exp_tbl, echo=FALSE}
f <- "/tmp/flourish_index_correlation_matrix.xlsx"
tbl <- cbind(rownames(tbl), as.data.frame(tbl))
names(tbl) <- c("", names(tbl)[-1])
write_xlsx(list(fi_cor_mat = tbl), f)
embed_file(f, text = "Flourish index - Correlation matrix (xlsx)")
f <- file.remove(f)
```

```{r fi_cor_fig_export, echo=FALSE}
fig <- ggpairs(subdat, progress = FALSE) +
  labs(caption = paste("Nombre d'observations :", nrow(subdat)))
f <- "/tmp/flourish_index_correlation_figure.pdf"
cairo_pdf(f, width = 21, height = 21, onefile = TRUE)
print(fig)
garbage <- dev.off()
embed_file(f, text = "Flourish index - Correlation matrix (pdf)")
f <- file.remove(f)
rm(f, fig, garbage, subdat, tbl)
```

### Exploratory factor analysis

Principal factor analysis with oblimin rotation

#### Flourish Index - Factor loadings

```{r efa_fi, message=FALSE}
subdat <- na.omit(hs[paste0("HFI", 1:10)])
subdat <- as.data.frame(lapply(subdat, as.numeric))
ld <- do.call(cbind, lapply(2:5, function(nfac) {
  efa <- fa(subdat, nfactors = nfac, rotate = "oblimin", SMC = FALSE, fm ="pa")
  ld <- as.data.frame(matrix(as.numeric(efa$loadings), ncol = nfac))
  rownames(ld) <- paste0("HFI", 1:10)
  colnames(ld) <- paste0(nfac, ".F", 1:nfac)
  ld
}))
tbl <- ld
tbl[abs(tbl) < 0.3] <- NA
kable(tbl, digits = 2)
```

```{r efa_fi_export_loadings, echo=FALSE}
f <- "/tmp/fi_efa_factor_loadings.xls"
write_xlsx(list(fi_efa_factor_loadings = tbl), f)
embed_file(f, text = "Flourish index - Factor loadings (xlsx)")
f <- file.remove(f)
rm(subdat, ld, tbl, f)
```

#### Secure Flourish Index - Factor loadings

```{r efa_sfi}
subdat <- na.omit(hs[paste0("HFI", 1:12)])
subdat <- as.data.frame(lapply(subdat, as.numeric))
ld <- do.call(cbind, lapply(2:6, function(nfac) {
  efa <- fa(subdat, nfactors = nfac, rotate = "oblimin", SMC = FALSE, fm ="pa")
  ld <- as.data.frame(matrix(as.numeric(efa$loadings), ncol = nfac))
  rownames(ld) <- paste0("HFI", 1:12)
  colnames(ld) <- paste0(nfac, ".F", 1:nfac)
  ld
}))
tbl <- ld
tbl[abs(tbl) < 0.3] <- NA
kable(tbl, digits = 2)
```

```{r efa_sfi_export_loadings, echo = FALSE}
f <- "/tmp/sfi_efa_factor_loadings.xls"
write_xlsx(list(sfi_efa_factor_loadings = tbl), f)
embed_file(f, text = "Secure Flourish index - Factor loadings (xlsx)")
f <- file.remove(f)
rm(subdat, ld, tbl, f)
```

### Confirmatory factor analysis

```{r cfa_fi_fits}
subdat <- na.omit(hs[paste0("HFI", 1:12)])
models <- list(
  fi_unidim = paste("FI =~", paste(paste0("HFI", 1:10), collapse = " + ")),
  fi_secorder = " d1 =~ HFI1 + HFI2
                  d2 =~ HFI3 + HFI4
                  d3 =~ HFI5 + HFI6
                  d4 =~ HFI7 + HFI8
                  d5 =~ HFI9 + HFI10
                  FI =~ d1 + d2 + d3 + d4 + d5 ",
  fi_bifactor = " d1 =~ HFI1 + HFI2
                 d2 =~ HFI3 + HFI4
                 d3 =~ HFI5 + HFI6
                 d4 =~ HFI7 + HFI8
                 d5 =~ HFI9 + HFI10
                 FI =~ HFI1 + HFI2 + HFI3 + HFI4 + HFI5 +
                   HFI6 + HFI7 + HFI8 + HFI9 + HFI10 ",
                 #                  d1 ~~ 0*d2
                 #                  d1 ~~ 0*d3
                 #                  d1 ~~ 0*d4
                 #                  d1 ~~ 0*d5
                 #                  d1 ~~ 0*FI
                 #                  d2 ~~ 0*d3
                 #                  d2 ~~ 0*d4
                 #                  d2 ~~ 0*d5
                 #                  d2 ~~ 0*FI
                 #                  d3 ~~ 0*d4
                 #                  d3 ~~ 0*d5
                 #                  d3 ~~ 0*FI
                 #                  d4 ~~ 0*d5
                 #                  d4 ~~ 0*FI
                 #                  d5 ~~ 0*FI ",
  sfi_unidim = paste("SFI =~", paste(paste0("HFI", 1:12), collapse = " + ")),
  sfi_secorder = " d1 =~ HFI1 + HFI2
                   d2 =~ HFI3 + HFI4
                   d3 =~ HFI5 + HFI6
                   d4 =~ HFI7 + HFI8
                   d5 =~ HFI9 + HFI10
                   d6 =~ HFI11 + HFI12
                   SFI =~ d1 + d2 + d3 + d4 + d5 + d6",
  sfi_bifactor = " d1 =~ HFI1 + HFI2
                  d2 =~ HFI3 + HFI4
                  d3 =~ HFI5 + HFI6
                  d4 =~ HFI7 + HFI8
                  d5 =~ HFI9 + HFI10
                  d6 =~ HFI11 + HFI12
                  SFI =~ HFI1 + HFI2 + HFI3 + HFI4 + HFI5 + HFI6 +
                    HFI7 + HFI8 + HFI9 + HFI10 + HFI11 + HFI12 "
)
evals_list <- lapply(models, function(m) {
  evals(paste0("cfa(m, subdat, orthogonal = TRUE, std.lv = TRUE)"),
        env = environment(), graph.dir = "/tmp")[[1]]
})
msgs <- lapply(evals_list, function(r) r$msg)
fits <- lapply(evals_list, function(r) r$result)
```

```{r cfa_fi_export_diagrams, echo=FALSE}
f <- "/tmp/cfa_fi_diagrams.pdf"
pdf(f, width = 16, height = 9)
layout(matrix(byrow = TRUE, nrow = 2, 1:6))
semPaths(fits[[1]], "model", "std", fixedStyle = c("white", 0))
title("Flourish index - Uni-dimensional model")
semPaths(fits[[2]], "model", "std", fixedStyle = c("white", 0))
title("Flourish index - Second-order model")
semPaths(fits[[3]], "model", "std", fixedStyle = c("white", 0),
         bifactor = "FI", layout = "tree2")
title("Flourish index - Bi-factor model")
semPaths(fits[[4]], "model", "std", fixedStyle = c("white", 0))
title("Secure flourish index - Uni-dimensional model")
semPaths(fits[[5]], "model", "std", fixedStyle = c("white", 0))
title("Secure flourish index - Second-order model")
semPaths(fits[[6]], "model", "std", fixedStyle = c("white", 0),
         bifactor = "SFI", layout = "tree2")
title("Secure flourish index - Bi-factor model")
garbage <- dev.off()

embed_file(f, text = "CFA - Diagrams (pdf)")
f <- file.remove(f)
rm(f, garbage)
```

#### Fit summary

<details><summary>Flourish index - Uni-dimensional model</summary>
```{r cfa_fi_unidim_summary, echo=FALSE}
if (!is.null(msgs[[1]]$warnings)) {
  gsub(" +", " ", gsub("\\n", " ", msgs[[1]]$warnings))
}
if (!is.null(msgs[[1]]$errors)) {
  gsub(" +", " ", gsub("\\n", " ", msgs[[1]]$errors))
}
summary(fits[[1]], fit.measures = TRUE)
```
</details>
<details><summary>Flourish index - Second-order model</summary>
```{r cfa_fi_secorder_summary, echo=FALSE}
if (!is.null(msgs[[2]]$warnings)) {
  gsub(" +", " ", gsub("\\n", " ", msgs[[2]]$warnings))
}
if (!is.null(msgs[[2]]$errors)) {
  gsub(" +", " ", gsub("\\n", " ", msgs[[2]]$errors))
}
summary(fits[[2]], fit.measures = TRUE)
```
</details>
<details><summary>Flourish index - Bi-factor model</summary>
```{r cfa_fi_bifactor_summary, echo=FALSE}
if (!is.null(msgs[[3]]$warnings)) {
  gsub(" +", " ", gsub("\\n", " ", msgs[[3]]$warnings))
}
if (!is.null(msgs[[3]]$errors)) {
  gsub(" +", " ", gsub("\\n", " ", msgs[[3]]$errors))
}
summary(fits[[3]], fit.measures = TRUE)
```
</details>

<details><summary>Secure flourish index - Uni-dimensional model</summary>
```{r cfa_sfi_unidim_summary, echo=FALSE}
if (!is.null(msgs[[4]]$warnings)) {
  gsub(" +", " ", gsub("\\n", " ", msgs[[4]]$warnings))
}
if (!is.null(msgs[[4]]$errors)) {
  gsub(" +", " ", gsub("\\n", " ", msgs[[4]]$errors))
}
summary(fits[[4]], fit.measures = TRUE)
```
</details>
<details><summary>Secure flourish index - Second-order model</summary>
```{r cfa_sfi_secorder_summary, echo=FALSE}
if (!is.null(msgs[[5]]$warnings)) {
  gsub(" +", " ", gsub("\\n", " ", msgs[[5]]$warnings))
}
if (!is.null(msgs[[5]]$errors)) {
  gsub(" +", " ", gsub("\\n", " ", msgs[[5]]$errors))
}
summary(fits[[5]], fit.measures = TRUE)
```
</details>
<details><summary>Secure flourish index - Bi-factor model</summary>
```{r cfa_sfi_bifactor_summary, echo=FALSE}
if (!is.null(msgs[[6]]$warnings)) {
  gsub(" +", " ", gsub("\\n", " ", msgs[[6]]$warnings))
}
if (!is.null(msgs[[6]]$errors)) {
  gsub(" +", " ", gsub("\\n", " ", msgs[[6]]$errors))
}
summary(fits[[6]], fit.measures = TRUE)
```
</details>

#### Models fit

```{r cfa_fi_fit_measures, out.width="100%"}
tbl <- do.call(rbind, lapply(names(fits), function(z) {
  s <- strsplit(z, "_")[[1]][[1]]
  s <- c(fi = "Flourish index", sfi = "Secure flourish index")[s]
  m <- strsplit(z, "_")[[1]][[2]]
  m <- c(unidim = "Uni-dimensional", secorder = "Second-order",
         bifactor = "Bi-factor")[m]
  measures <- c("cfi", "tli", "rmsea", "srmr")
  if (lavInspect(fits[[z]], "converged")) {
    r <- fitMeasures(fits[[z]], measures) %>%
      {setNames(as.numeric(.), names(.))}
  } else {
    r <- setNames(rep(NA, length(measures)), measures)
  }
  cbind(Score = s, Model = m, data.frame(t(r)))
}))
kable(tbl, row.names = FALSE)
```

```{r cfa_fi_fit_measures_export_table, echo=FALSE}
f <- "/tmp/cfa_fi_fit_measures.xls"
write_xlsx(list(cfa_fi_fit_measures = tbl), f)
embed_file(f, text = "Flourish index - CFA fit measures (xlsx)")
f <- file.remove(f)
rm(tbl, f)
```

#### Factor loadings

```{r cfa_fi_bifactor_loadings}
tbl1 <- lavInspect(fits[[3]], what = "est")$lambda
colnames(tbl1) <- paste0("FI.", colnames(tbl1))
tbl2 <- lavInspect(fits[[6]], what = "est")$lambda
colnames(tbl2) <- paste0("SFI.", colnames(tbl2))
tbl <- merge(tbl1, tbl2, by = "row.names", all = TRUE, sort = FALSE)
kable(tbl, digits = 2)
```

```{r  cfa_fi_bifactor_loadings_export_table, echo=FALSE}
f <- "/tmp/cfa_fi_bifactor_loadings.xls"
write_xlsx(list(cfa_fi_fit_measures = tbl), f)
embed_file(f, text = "Loadings of bi-factor models (xlsx)")
f <- file.remove(f)
rm(tbl1, tbl2, tbl, f)
```

#### Standardized factor loadings

```{r cfa_fi_bifactor_loadings}
tbl1 <- lavInspect(fits[[3]], what = "std")$lambda
colnames(tbl1) <- paste0("FI.", colnames(tbl1))
tbl2 <- lavInspect(fits[[6]], what = "std")$lambda
colnames(tbl2) <- paste0("SFI.", colnames(tbl2))
tbl <- merge(tbl1, tbl2, by = "row.names", all = TRUE, sort = FALSE)
kable(tbl, digits = 2)
```

```{r  cfa_fi_bifactor_loadings_export_table, echo=FALSE}
f <- "/tmp/cfa_fi_bifactor_standardized_loadings.xls"
write_xlsx(list(cfa_fi_fit_measures = tbl), f)
embed_file(f, text = "Standardized loadings of bi-factor models (xlsx)")
f <- file.remove(f)
rm(tbl1, tbl2, tbl, f)
```

#### Reliability

<!--
  References :
  reise2010bifactor
  reise2013multidimensionality
-->

```{r cfa_fi_bifactor_reliability}

# Function that calculates the differences reliability measures
bifactrel <- function(index = "fi", std = FALSE) {
  if (index == "fi") {
    fit <- fits[[3]]
    k <- 5
  } else {
    fit <- fits[[6]]
    k <- 6
  }
  if (std) what = "std" else what = "est"
  n <- rep(2, k)
  lambda <- lavInspect(fit, what = what)$lambda
  theta <- diag(lavInspect(fit, what = what)$theta)
  j <- grep("^(S)?FI$", colnames(lambda))
  ecv <- sum(lambda[, j]^2) / sum(lambda^2)
  puc <- 1 - sum(n * (n - 1) / 2) / (sum(n) * (sum(n) - 1) / 2)
  omegah <- sum(lambda[, j])^2 /
    (sum(lambda[, j])^2 + sum(apply(lambda[, -j], 2, sum)^2) + sum(theta))
  omegahs <- sapply(1:k, function(l) {
    d <- paste0("d", l)
    i <- paste0("HFI", l * 2 + c(-1, 0))
    sum(lambda[i, d])^2 /
      (sum(lambda[i, j])^2 + sum(lambda[i, d])^2 + sum(theta[i]))
  })
  list(ecv = ecv, puc = puc, omegah = omegah, omegahs = omegahs)
}

# Tables of reliability measures
tab_rm <- lapply(c(FALSE, TRUE), function(std) {
  tbl <- do.call(rbind, lapply(1:2, function(k) {
    index <- c("fi", "sfi")[k]
    Index <- "Flourish Index" %>% {c(., paste("Secure", .))}
    r <- bifactrel(index, std)
    M <- matrix(NA, nrow = 4, ncol = 7)
    rownames(M) <- c("PUC", "ECV", "OmegaH", "OmegaHS")
    colnames(M) <- c("GF", paste0("D", 1:6))
    M["PUC", 1] <- r$puc
    M["ECV", 1] <- r$ecv
    M["OmegaH", 1] <- r$omegah
    M["OmegaHS", (1:length(r$omegahs)) + 1] <- r$omegahs
    cbind(data.frame(Index = Index[k], Reliability_measure = rownames(M)), M)
  }))
  rownames(tbl) <- NULL
  return(tbl)
})
names(tab_rm) <- c("unstandardized", "standardized")

```

**Reliability measures based on unstandardized loadings**

```{r cfa_fi_bifactor_table_reliability_unstandardized}
kable(tab_rm$unstandardized, digits = 3)
```

```{r cfa_fi_bifactor_export_table_reliability_unstandardized, echo=FALSE}
f <- "/tmp/cfa_fi_bifactor_reliability_unstd.xls"
write_xlsx(list(cfa_fi_reliability_unstd = tab_rm$unstandardized), f)
embed_file(f, text = "Reliability measures of bi-factor models [unstd] (xlsx)")
f <- file.remove(f)
rm(f)
```

**Reliability measures based on standardized loadings**

```{r cfa_fi_bifactor_table_reliability_standardized}
kable(tab_rm$standardized, digits = 3)
```

```{r cfa_fi_bifactor_export_table_reliability_standardized, echo=FALSE}
f <- "/tmp/cfa_fi_bifactor_reliability_std.xls"
write_xlsx(list(cfa_fi_reliability_std = tab_rm$standardized), f)
embed_file(f, text = "Reliability measures of bi-factor models [std] (xlsx)")
f <- file.remove(f)
rm(f)
```

```{r cfa_fi_bifactor_reliability_measures_tests, eval=FALSE, echo=FALSE}
library(BifactorIndicesCalculator)
bifactorIndices(fits[[3]], standardized = FALSE)
bifactorIndices(fits[[3]], standardized = TRUE)
```

<!-- ============================ Reference(s) ============================ -->

<!--

Histogram breaks: https://stackoverflow.com/questions/25146544/

Embed files: https://bookdown.org/yihui/rmarkdown-cookbook/embed-file.html

-->
